<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Battle of Trafalgar - Historical Naval Battle Simulation</title>
    
    <!-- Google Maps API -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5Q6XfXpLvGz8zK3Xb1HwHfGhKvQDqb2M&callback=initMap&libraries=geometry">
    </script>
    
    <!-- D3.js for ship animations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif;
            overflow: hidden;
            background: #1a237e;
            touch-action: none;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .battle-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .battle-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1001;
            max-width: 350px;
            pointer-events: auto;
            border: 2px solid #8B4513;
        }
        
        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1001;
            pointer-events: auto;
            border: 2px solid #8B4513;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1001;
            pointer-events: auto;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .control-btn {
            background: linear-gradient(145deg, #8B4513, #654321);
            color: white;
            border: 2px solid #A0522D;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            user-select: none;
        }
        
        .control-btn:hover, .control-btn:active {
            background: linear-gradient(145deg, #A0522D, #8B4513);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1001;
            pointer-events: auto;
        }
        
        .zoom-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 2px solid #8B4513;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .zoom-btn:hover, .zoom-btn:active {
            background: rgba(139, 69, 19, 0.8);
            transform: scale(1.1);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .battle-info, .legend {
                font-size: 12px;
                padding: 10px;
                max-width: 280px;
            }
            
            .controls {
                left: 10px;
                right: 10px;
                bottom: 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .control-row {
                justify-content: center;
                gap: 8px;
            }
            
            .control-btn {
                padding: 14px 18px;
                font-size: 13px;
                min-width: 120px;
                flex: 1;
            }
            
            .zoom-controls {
                right: 10px;
                gap: 10px;
            }
            
            .zoom-btn {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
        }
        
        @media (max-width: 480px) {
            .battle-info {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .legend {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 8px;
            }
        }
        
        /* Ship animations */
        .ship {
            pointer-events: auto;
            cursor: pointer;
        }
        
        .ship-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1002;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #8B4513;
            max-width: 250px;
        }
        
        /* Cannon effects */
        .cannon-fire {
            pointer-events: none;
        }
        
        .muzzle-flash {
            fill: #FFD700;
            filter: blur(1px);
        }
        
        .cannonball {
            fill: #2F4F4F;
            stroke: #1a1a1a;
            stroke-width: 1;
        }
        
        .smoke {
            fill: #696969;
            opacity: 0.7;
        }
        
        .explosion {
            pointer-events: none;
        }
        
        .water-splash {
            fill: none;
            stroke: rgba(255, 255, 255, 0.8);
            stroke-width: 2;
        }
        
        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a237e, #3f51b5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Audio prompt animation */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(218, 165, 32, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(218, 165, 32, 0); }
            100% { box-shadow: 0 0 0 0 rgba(218, 165, 32, 0); }
        }
        
        .audio-prompt {
            animation: pulse 2s infinite;
        }
        
        /* Journey path animation */
        .journey-path {
            fill: none;
            stroke: rgba(255, 215, 0, 0.6);
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            animation: dash 2s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -15;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <h2>Loading Battle of Trafalgar</h2>
        <p>Preparing historical naval simulation...</p>
    </div>

    <div id="map"></div>
    
    <div class="battle-overlay">
        <div class="battle-info">
            <h3>Battle of Trafalgar - October 21, 1805</h3>
            <div id="battle-status">Ships gathering at their home ports...</div>
            <div id="san-ildefonso-status"><strong>San Ildefonso:</strong> Ready in Cadiz</div>
            <div id="casualties">Ships lost: 0</div>
            <div id="time">Time: 06:00 AM</div>
            <div id="weather">Wind: Light SW breeze, 10 knots</div>
            <div id="coordinates">Battle Zone: 36°18'N, 6°15'W</div>
        </div>
        
        <div class="legend">
            <h4>Fleet Legend</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #C41E3A;"></div>
                <span>Spanish Fleet</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #0055A4;"></div>
                <span>French Fleet</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #012169;"></div>
                <span>British Fleet</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD700;"></div>
                <span>San Ildefonso (Focus)</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <button class="control-btn" id="startJourneyBtn" onclick="startJourney()">Begin Journey</button>
                <button class="control-btn" id="startBattleBtn" onclick="startBattle()" disabled>Start Battle</button>
                <button class="control-btn" onclick="pauseBattle()">Pause</button>
                <button class="control-btn" onclick="resetBattle()">Reset</button>
            </div>
            <div class="control-row">
                <button class="control-btn" onclick="focusOnSanIldefonso()">Focus San Ildefonso</button>
                <button class="control-btn" onclick="toggleSpeed()" id="speedBtn">Speed: 1x</button>
                <button class="control-btn" onclick="toggleSound()" id="soundBtn">Sound: ON</button>
            </div>
        </div>
        
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="zoomOut()">−</button>
        </div>
        
        <div class="ship-tooltip" id="tooltip"></div>
        
        <svg class="battle-overlay" id="battle-svg" width="100%" height="100%"></svg>
    </div>

    <script>
        // Global variables
        let map, battleSvg, ships = [], cannonFires = [], 
            battleStarted = false, battlePaused = false, journeyStarted = false,
            battleTime = 0, casualties = 0, battleSpeed = 1,
            audioContext, soundEnabled = true, audioInitialized = false, 
            isMobile = false, audioUnlocked = false;
        
        // Audio files for realistic cannon sounds
        const audioFiles = {
            cannon1: 'data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAADAAABtQC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7///////////////////////////////////////////////////////////////////////////////////AAAAAExhdmM1OC4zNQAAAAAAAAAAAAAAACQCiAUAAAAAAAAAAbVpD0QlAAAAAAAAAAAAAAAAAAAA//uQxAAABUgNdPagAAgAAA0gAAABAQIHAAMAAAAtAgAAANUNUPIPp8nfvKJv4AAiKxd/8L+/CCBd5r4TmPZoJY0/vOjZAhWJl0u2s31CCeShASYtgHBFAEcGfxIx4mDbH7bFOu8vd1w/DYKFhPdh9e5s6cADhNAK8UOjt1Ql1Guw+3Xno1PtOJtXTdOJJ5OdjW1P58WoFhEQnp4QfzaC0AiqsAQnCJw83Xc6bF8JUv3GBRr5qdXQqVWJ5Odjbd2fn4tfxSJe3iVDt0Q+DUIACjSO1AFD7/J8AAIC9QqrBxrC4/kIwNKxsebg6w4A/0ZJCjIq+gVoGkIyNSEjqIRhGDFvOyQMoF5CRAMHGJyYNVVoALc6xX4VDExTDGMIAMDqvQRBHQIIVQCrAq8qAlZVf5SJzwZR9FNVCOAh8BCELqAoZzMM6wVnWNZFG55KJokwEcAAtIIwVQowP4AgcKBJIHhQQPRUAoAfAGCqQMF7BgTqAIWTEwWcAYK2DAqgFAvYJAmgCOLAWP4AWDEQN2DAWP4Cg5MIggYKAmAJgGgaBQWYCBZAhCJgEHaAAWwKBYAID2AQMWCgQMEAmAJgMF2AgSsBAxYJAkgGgWBgCBZAJFrBIIwAAswGgWBgKwIBJgFgWAYKwIAh4UhQGQgKwHhCGQsE8AYgm0DgeAAMWDwR6hMHggRz9CEQAHCgADSAIBFtAogn0FAAA==',
            cannon2: 'data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAADAAABtQC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7///////////////////////////////////////////////////////////////////////////////////AAAAAExhdmM1OC4zNQAAAAAAAAAAAAAAACQCiAUAAAAAAAAAAbVpD0QlAAAAAAAAAAAAAAAAAAAA//uQxAAABUgNdPagAAgAAA0gAAABAQIHAAMAAAAtAgAAANUNUPIPp8nfvKJv4AAiKxd/8L+/CCBd5r4TmPZoJY0/vOjZAhWJl0u2s31CCeShASYtgHBFAEcGfxIx4mDbH7bFOu8vd1w/DYKFhPdh9e5s6cADhNAK8UOjt1Ql1Guw+3Xno1PtOJtXTdOJJ5OdjW1P58WoFhEQnp4QfzaC0AiqsAQnCJw83Xc6bF8JUv3GBRr5qdXQqVWJ5Odjbd2fn4tfxSJe3iVDt0Q+DUIACjSO1AFD7/J8AAIC9QqrBxrC4/kIwNKxsebg6w4A/0ZJCjIq+gVoGkIyNSEjqIRhGDFvOyQMoF5CRAMHGJyYNVVoALc6xX4VDExTDGMIAMDqvQRBHQIIVQCrAq8qAlZVf5SJzwZR9FNVCOAh8BCELqAoZzMM6wVnWNZFG55KJokwEcAAtIIwVQowP4AgcKBJIHhQQPRUAoAfAGCqQMF7BgTqAIWTEwWcAYK2DAqgFAvYJAmgCOLAWP4AWDEQN2DAWP4Cg5MIggYKAmAJgGgaBQWYCBZAhCJgEHaAAWwKBYAID2AQMWCgQMEAmAJgMF2AgSsBAxYJAkgGgWBgCBZAJFrBIIwAAswGgWBgKwIBJgFgWAYKwIAh4UhQGQgKwHhCGQsE8AYgm0DgeAAMWDwR6hMHggRz9CEQAHCgADSAIBFtAogn0FAAA==',
            explosion: 'data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAADAAABtQC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7///////////////////////////////////////////////////////////////////////////////////AAAAAExhdmM1OC4zNQAAAAAAAAAAAAAAACQCiAUAAAAAAAAAAbVpD0QlAAAAAAAAAAAAAAAAAAAA//uQxAAABUgNdPagAAgAAA0gAAABAQIHAAMAAAAtAgAAANUNUPIPp8nfvKJv4AAiKxd/8L+/CCBd5r4TmPZoJY0/vOjZAhWJl0u2s31CCeShASYtgHBFAEcGfxIx4mDbH7bFOu8vd1w/DYKFhPdh9e5s6cADhNAK8UOjt1Ql1Guw+3Xno1PtOJtXTdOJJ5OdjW1P58WoFhEQnp4QfzaC0AiqsAQnCJw83Xc6bF8JUv3GBRr5qdXQqVWJ5Odjbd2fn4tfxSJe3iVDt0Q+DUIACjSO1AFD7/J8AAIC9QqrBxrC4/kIwNKxsebg6w4A/0ZJCjIq+gVoGkIyNSEjqIRhGDFvOyQMoF5CRAMHGJyYNVVoALc6xX4VDExTDGMIAMDqvQRBHQIIVQCrAq8qAlZVf5SJzwZR9FNVCOAh8BCELqAoZzMM6wVnWNZFG55KJokwEcAAtIIwVQowP4AgcKBJIHhQQPRUAoAfAGCqQMF7BgTqAIWTEwWcAYK2DAqgFAvYJAmgCOLAWP4AWDEQN2DAWP4Cg5MIggYKAmAJgGgaBQWYCBZAhCJgEHaAAWwKBYAID2AQMWCgQMEAmAJgMF2AgSsBAxYJAkgGgWBgCBZAJFrBIIwAAswGgWBgKwIBJgFgWAYKwIAh4UhQGQgKwHhCGQsE8AYgm0DgeAAMWDwR6hMHggRz9CEQAHCgADSAIBFtAogn0FAAA=='
        };
        
        // Battle coordinates (off Cape Trafalgar)
        const BATTLE_COORDS = { lat: 36.2930, lng: -6.2553 };
        
        // Home ports
        const HOME_PORTS = {
            spanish: { lat: 36.5297, lng: -6.2920, name: "Cadiz" }, // Cadiz, Spain
            french: { lat: 43.2965, lng: 5.3698, name: "Toulon" }, // Toulon, France  
            british: { lat: 50.7984, lng: -1.1112, name: "Portsmouth" } // Portsmouth, England
        };
        
        // Historical ship data
        const fleetData = {
            spanish: [
                { name: "San Ildefonso", type: "Ship of the Line", guns: 74, flagship: true, crew: 640 },
                { name: "Santísima Trinidad", type: "First Rate", guns: 136, crew: 1048 },
                { name: "Santa Ana", type: "Ship of the Line", guns: 112, crew: 810 },
                { name: "San Juan Nepomuceno", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "San Justo", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "San Leandro", type: "Ship of the Line", guns: 64, crew: 520 },
                { name: "Monarca", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Neptuno", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "Bahama", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "San Francisco de Asís", type: "Ship of the Line", guns: 74, crew: 640 }
            ],
            french: [
                { name: "Bucentaure", type: "Ship of the Line", guns: 80, flagship: true, crew: 690 },
                { name: "Redoutable", type: "Ship of the Line", guns: 74, crew: 643 },
                { name: "Neptune", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "Fougueux", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Indomptable", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "Intrépide", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Aigle", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Achille", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Berwick", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Algésiras", type: "Ship of the Line", guns: 74, crew: 640 }
            ],
            british: [
                { name: "HMS Victory", type: "First Rate", guns: 104, flagship: true, crew: 820 },
                { name: "HMS Royal Sovereign", type: "First Rate", guns: 100, flagship: true, crew: 800 },
                { name: "HMS Temeraire", type: "Ship of the Line", guns: 98, crew: 750 },
                { name: "HMS Neptune", type: "Ship of the Line", guns: 98, crew: 750 },
                { name: "HMS Conqueror", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Leviathan", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Ajax", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Agamemnon", type: "Ship of the Line", guns: 64, crew: 520 },
                { name: "HMS Bellerophon", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Colossus", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Britannia", type: "First Rate", guns: 100, crew: 800 },
                { name: "HMS Tonnant", type: "Ship of the Line", guns: 80, crew: 690 }
            ]
        };
        
        // Detect mobile devices
        function detectMobile() {
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);
        }
        
        // Initialize Google Maps
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: BATTLE_COORDS,
                mapTypeId: google.maps.MapTypeId.SATELLITE,
                disableDefaultUI: true,
                gestureHandling: isMobile ? 'greedy' : 'cooperative',
                styles: [
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#0066cc" }]
                    },
                    {
                        featureType: "landscape",
                        elementType: "geometry",
                        stylers: [{ color: "#8fbc8f" }]
                    }
                ]
            });
            
            // Add historical markers
            addHistoricalMarkers();
            
            // Initialize battle overlay
            initBattleOverlay();
            
            // Hide loading screen
            document.getElementById('loadingScreen').style.display = 'none';
        }
        
        function addHistoricalMarkers() {
            // Battle location marker
            new google.maps.Marker({
                position: BATTLE_COORDS,
                map: map,
                title: "Battle of Trafalgar - October 21, 1805",
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#ff4444" stroke="#fff" stroke-width="2"/>
                            <text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-weight="bold">⚔</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            
            // Home port markers
            Object.entries(HOME_PORTS).forEach(([fleet, port]) => {
                const color = fleet === 'spanish' ? '#C41E3A' : fleet === 'french' ? '#0055A4' : '#012169';
                new google.maps.Marker({
                    position: port,
                    map: map,
                    title: `${port.name} - ${fleet.charAt(0).toUpperCase() + fleet.slice(1)} Home Port`,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="30" height="30" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="15" cy="15" r="12" fill="${color}" stroke="#fff" stroke-width="2"/>
                                <text x="15" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">⚓</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(30, 30)
                    }
                });
            });
        }
        
        function initBattleOverlay() {
            detectMobile();
            initAudio();
            battleSvg = d3.select("#battle-svg");
            prepareShips();
            updateBattleStatus();
            
            // Add touch/mouse controls for mobile
            if (isMobile) {
                addTouchControls();
            }
        }
        
        function addTouchControls() {
            let isPanning = false;
            let startCenter = null;
            
            // Pan controls
            map.addListener('dragstart', () => {
                isPanning = true;
            });
            
            map.addListener('dragend', () => {
                isPanning = false;
            });
            
            // Zoom controls with gestures
            map.addListener('zoom_changed', () => {
                updateShipScale();
            });
        }
        
        function updateShipScale() {
            const zoom = map.getZoom();
            const scale = Math.max(0.5, Math.min(2, zoom / 8));
            battleSvg.selectAll('.ship').attr('transform', d => 
                `translate(${d.screenX || 0}, ${d.screenY || 0}) scale(${scale}) rotate(${d.angle || 0})`
            );
        }
        
        // Audio system initialization
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (isMobile) {
                    addMobileAudioHandlers();
                } else {
                    audioInitialized = true;
                    audioUnlocked = true;
                }
            } catch (e) {
                console.warn("Audio not supported");
                soundEnabled = false;
            }
            updateSoundButton();
        }
        
        function addMobileAudioHandlers() {
            const unlockAudio = () => {
                if (audioContext && !audioUnlocked) {
                    const source = audioContext.createBufferSource();
                    const buffer = audioContext.createBuffer(1, 1, 22050);
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start(0);
                    
                    audioContext.resume().then(() => {
                        audioUnlocked = true;
                        audioInitialized = true;
                        updateSoundButton();
                    });
                    
                    document.removeEventListener('touchstart', unlockAudio);
                    document.removeEventListener('click', unlockAudio);
                }
            };
            
            document.addEventListener('touchstart', unlockAudio, false);
            document.addEventListener('click', unlockAudio, false);
        }
        
        function playAudioFile(audioKey, volume = 0.3) {
            if (!soundEnabled || !audioContext || !audioUnlocked) return;
            
            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // For this demo, we'll use Web Audio API to generate sounds
                // In production, you'd load actual MP3 files
                if (audioKey === 'cannon') {
                    playCannonSound();
                } else if (audioKey === 'explosion') {
                    playExplosionSound();
                }
            } catch (e) {
                console.warn("Error playing audio:", e);
            }
        }
        
        function playCannonSound() {
            if (!audioContext || !audioUnlocked) return;
            
            const duration = 1.2;
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration;
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < length; i++) {
                const t = i / sampleRate;
                let sample = 0;
                
                if (t < 0.1) {
                    const attack = Math.exp(-t * 30);
                    sample += attack * (Math.random() * 2 - 1) * 0.5;
                    sample += attack * Math.sin(2 * Math.PI * 150 * t) * 0.3;
                } else {
                    const decay = Math.exp(-(t - 0.1) * 4);
                    sample += decay * Math.sin(2 * Math.PI * 80 * t) * 0.2;
                }
                
                data[i] = sample;
            }
            
            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();
            source.buffer = buffer;
            gainNode.gain.value = 0.4;
            
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start();
        }
        
        function playExplosionSound() {
            if (!audioContext || !audioUnlocked) return;
            
            const duration = 2.0;
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration;
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < length; i++) {
                const t = i / sampleRate;
                let sample = 0;
                
                if (t < 0.2) {
                    const blast = Math.exp(-t * 15);
                    sample += blast * (Math.random() * 2 - 1) * 0.8;
                    sample += blast * Math.sin(2 * Math.PI * 120 * t) * 0.4;
                } else {
                    const rumble = Math.exp(-(t - 0.2) * 3);
                    sample += rumble * Math.sin(2 * Math.PI * 40 * t) * 0.3;
                    sample += rumble * (Math.random() * 2 - 1) * 0.1;
                }
                
                data[i] = sample;
            }
            
            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();
            source.buffer = buffer;
            gainNode.gain.value = 0.6;
            
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start();
        }
        
        function prepareShips() {
            ships = [];
            let id = 0;
            
            Object.keys(fleetData).forEach(fleet => {
                const homePort = HOME_PORTS[fleet];
                fleetData[fleet].forEach((shipData, index) => {
                    // Position ships around their home ports
                    const angle = (index / fleetData[fleet].length) * 2 * Math.PI;
                    const radius = 0.02; // Small radius in lat/lng
                    
                    ships.push({
                        id: id++,
                        ...shipData,
                        fleet: fleet,
                        health: 100,
                        sunk: false,
                        angle: 0,
                        inCombat: false,
                        target: null,
                        lastFired: 0,
                        morale: 100,
                        damage: 0,
                        // Starting position at home port
                        lat: homePort.lat + Math.cos(angle) * radius,
                        lng: homePort.lng + Math.sin(angle) * radius,
                        // Journey state
                        journeyProgress: 0,
                        atBattle: false
                    });
                });
            });
            
            drawShips();
        }
        
        function drawShips() {
            // Clear existing ships
            battleSvg.selectAll('.ship').remove();
            
            const shipGroups = battleSvg.selectAll('.ship')
                .data(ships, d => d.id)
                .enter()
                .append('g')
                .attr('class', 'ship')
                .attr('data-ship-id', d => d.id)
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                    focusOnShip(d);
                })
                .on('mouseover', function(event, d) {
                    showTooltip(event, d);
                })
                .on('mouseout', function() {
                    hideTooltip();
                });
            
            // Ship hulls
            shipGroups.append('ellipse')
                .attr('rx', d => d.guns > 100 ? 25 : d.guns > 80 ? 20 : 16)
                .attr('ry', d => d.guns > 100 ? 8 : d.guns > 80 ? 6 : 5)
                .attr('fill', d => {
                    if (d.name === "San Ildefonso") return "#FFD700";
                    return d.fleet === "spanish" ? "#C41E3A" : 
                           d.fleet === "french" ? "#0055A4" : "#012169";
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 1);
            
            // Ship names
            shipGroups.append('text')
                .attr('y', -20)
                .attr('text-anchor', 'middle')
                .attr('font-size', '8px')
                .attr('font-weight', 'bold')
                .attr('fill', 'white')
                .attr('stroke', 'black')
                .attr('stroke-width', 0.5)
                .text(d => d.name.length > 15 ? d.name.substring(0, 12) + '...' : d.name);
            
            // Health bars
            const healthBars = shipGroups.append('g').attr('class', 'health-bar');
            
            healthBars.append('rect')
                .attr('x', -10)
                .attr('y', 15)
                .attr('width', 20)
                .attr('height', 3)
                .attr('fill', '#333')
                .attr('stroke', '#fff')
                .attr('stroke-width', 0.5);
                
            healthBars.append('rect')
                .attr('x', -10)
                .attr('y', 15)
                .attr('width', d => 20 * (d.health / 100))
                .attr('height', 3)
                .attr('fill', d => d.health > 70 ? '#4CAF50' : d.health > 30 ? '#FFC107' : '#F44336')
                .attr('class', 'health-fill');
            
            updateShipPositions();
        }
        
        function updateShipPositions() {
            ships.forEach(ship => {
                const point = latLngToPoint(ship.lat, ship.lng);
                if (point) {
                    ship.screenX = point.x;
                    ship.screenY = point.y;
                }
            });
            
            battleSvg.selectAll('.ship')
                .attr('transform', d => `translate(${d.screenX || 0}, ${d.screenY || 0}) rotate(${d.angle || 0})`);
        }
        
        function latLngToPoint(lat, lng) {
            const projection = map.getProjection();
            if (projection) {
                const point = projection.fromLatLngToPoint(new google.maps.LatLng(lat, lng));
                const scale = Math.pow(2, map.getZoom());
                const worldPoint = new google.maps.Point(point.x * scale, point.y * scale);
                const topLeft = map.getBounds().getNorthEast();
                const bottomRight = map.getBounds().getSouthWest();
                const topLeftPoint = projection.fromLatLngToPoint(topLeft);
                const bottomRightPoint = projection.fromLatLngToPoint(bottomRight);
                const topLeftWorldPoint = new google.maps.Point(topLeftPoint.x * scale, topLeftPoint.y * scale);
                
                return {
                    x: worldPoint.x - topLeftWorldPoint.x,
                    y: worldPoint.y - topLeftWorldPoint.y
                };
            }
            return null;
        }
        
        // Control functions
        function startJourney() {
            if (journeyStarted) return;
            
            journeyStarted = true;
            document.getElementById('startJourneyBtn').disabled = true;
            document.getElementById('startJourneyBtn').textContent = 'Journey In Progress...';
            
            updateBattleStatus("Ships departing from home ports...");
            
            // Animate ships to battle location
            animateJourney();
        }
        
        function animateJourney() {
            const journeyDuration = 8000; // 8 seconds
            const startTime = Date.now();
            
            function updateJourney() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / journeyDuration, 1);
                
                ships.forEach(ship => {
                    const homePort = HOME_PORTS[ship.fleet];
                    const latDiff = BATTLE_COORDS.lat - homePort.lat;
                    const lngDiff = BATTLE_COORDS.lng - homePort.lng;
                    
                    // Add some formation positioning
                    const formationOffset = {
                        lat: (Math.random() - 0.5) * 0.01,
                        lng: (Math.random() - 0.5) * 0.01
                    };
                    
                    ship.lat = homePort.lat + (latDiff * progress) + formationOffset.lat;
                    ship.lng = homePort.lng + (lngDiff * progress) + formationOffset.lng;
                    
                    // Update angle based on movement direction
                    ship.angle = Math.atan2(lngDiff, latDiff) * (180 / Math.PI);
                });
                
                updateShipPositions();
                
                // Update status
                const percentage = Math.round(progress * 100);
                updateBattleStatus(`Journey progress: ${percentage}% - Ships sailing to battle...`);
                
                if (progress < 1) {
                    requestAnimationFrame(updateJourney);
                } else {
                    onJourneyComplete();
                }
            }
            
            updateJourney();
        }
        
        function onJourneyComplete() {
            ships.forEach(ship => {
                ship.atBattle = true;
            });
            
            document.getElementById('startBattleBtn').disabled = false;
            document.getElementById('startBattleBtn').classList.add('audio-prompt');
            updateBattleStatus("All fleets have arrived! Ready for battle!");
        }
        
        function startBattle() {
            if (!journeyStarted || battleStarted) return;
            
            // Enable audio context on user interaction
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // Mobile audio unlock
            if (isMobile && audioContext && !audioUnlocked) {
                const source = audioContext.createBufferSource();
                const buffer = audioContext.createBuffer(1, 1, 22050);
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start(0);
                
                audioContext.resume().then(() => {
                    audioUnlocked = true;
                    audioInitialized = true;
                    updateSoundButton();
                });
            }
            
            battleStarted = true;
            battlePaused = false;
            battleTime = 0;
            
            document.getElementById('startBattleBtn').classList.remove('audio-prompt');
            document.getElementById('startBattleBtn').disabled = true;
            
            updateBattleStatus("Battle commenced! Nelson's attack begins!");
            
            // Focus map on battle area
            map.setCenter(BATTLE_COORDS);
            map.setZoom(12);
            
            simulateBattle();
        }
        
        function pauseBattle() {
            battlePaused = !battlePaused;
            const btn = event.target;
            btn.textContent = battlePaused ? 'Resume' : 'Pause';
            updateBattleStatus(battlePaused ? "Battle paused" : "Battle resumed");
        }
        
        function resetBattle() {
            battleStarted = false;
            battlePaused = false;
            journeyStarted = false;
            battleTime = 0;
            casualties = 0;
            
            // Reset ships
            ships.forEach(ship => {
                const homePort = HOME_PORTS[ship.fleet];
                const index = ships.filter(s => s.fleet === ship.fleet).indexOf(ship);
                const angle = (index / fleetData[ship.fleet].length) * 2 * Math.PI;
                const radius = 0.02;
                
                ship.health = 100;
                ship.sunk = false;
                ship.inCombat = false;
                ship.target = null;
                ship.morale = 100;
                ship.damage = 0;
                ship.lat = homePort.lat + Math.cos(angle) * radius;
                ship.lng = homePort.lng + Math.sin(angle) * radius;
                ship.angle = 0;
                ship.atBattle = false;
            });
            
            // Reset UI
            document.getElementById('startJourneyBtn').disabled = false;
            document.getElementById('startJourneyBtn').textContent = 'Begin Journey';
            document.getElementById('startBattleBtn').disabled = true;
            document.getElementById('startBattleBtn').classList.remove('audio-prompt');
            document.querySelector('[onclick="pauseBattle()"]').textContent = 'Pause';
            
            // Clear effects
            battleSvg.selectAll('.cannon-fire').remove();
            battleSvg.selectAll('.explosion').remove();
            
            updateShipPositions();
            updateBattleStatus("Ships gathering at their home ports...");
            
            // Reset map view
            map.setCenter(BATTLE_COORDS);
            map.setZoom(8);
        }
        
        function toggleSpeed() {
            battleSpeed = battleSpeed === 1 ? 2 : battleSpeed === 2 ? 4 : 1;
            document.getElementById('speedBtn').textContent = `Speed: ${battleSpeed}x`;
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            updateSoundButton();
        }
        
        function updateSoundButton() {
            const button = document.getElementById('soundBtn');
            if (button) {
                let buttonText = "Sound: ";
                button.classList.remove('audio-prompt');
                
                if (!audioContext) {
                    buttonText += "UNAVAILABLE";
                    button.style.background = "#555";
                } else if (isMobile && !audioUnlocked) {
                    buttonText += soundEnabled ? "TAP TO ENABLE" : "OFF";
                    button.style.background = soundEnabled ? "#DAA520" : "#555";
                    if (soundEnabled) {
                        button.classList.add('audio-prompt');
                    }
                } else {
                    buttonText += soundEnabled ? "ON" : "OFF";
                    button.style.background = soundEnabled ? "" : "#555";
                }
                button.textContent = buttonText;
            }
        }
        
        function focusOnSanIldefonso() {
            const sanIldefonso = ships.find(s => s.name === "San Ildefonso");
            if (sanIldefonso) {
                focusOnShip(sanIldefonso);
            }
        }
        
        function focusOnShip(ship) {
            map.setCenter({ lat: ship.lat, lng: ship.lng });
            map.setZoom(14);
            
            // Highlight ship
            battleSvg.selectAll('.ship').style('opacity', 0.5);
            battleSvg.select(`[data-ship-id="${ship.id}"]`).style('opacity', 1);
            
            setTimeout(() => {
                battleSvg.selectAll('.ship').style('opacity', 1);
                map.setZoom(12);
            }, 3000);
        }
        
        function zoomIn() {
            const zoom = map.getZoom();
            map.setZoom(Math.min(zoom + 1, 20));
        }
        
        function zoomOut() {
            const zoom = map.getZoom();
            map.setZoom(Math.max(zoom - 1, 3));
        }
        
        function showTooltip(event, ship) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.innerHTML = `
                <strong>${ship.name}</strong><br/>
                Fleet: ${ship.fleet.charAt(0).toUpperCase() + ship.fleet.slice(1)}<br/>
                Type: ${ship.type}<br/>
                Guns: ${ship.guns}<br/>
                Crew: ${ship.crew}<br/>
                Health: ${Math.round(ship.health)}%<br/>
                Morale: ${Math.round(ship.morale)}%<br/>
                ${ship.flagship ? '<em>⭐ Flagship</em><br/>' : ''}
                ${ship.inCombat ? '<em>🔥 In Combat</em>' : ''}
            `;
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }
        
        function simulateBattle() {
            if (!battleStarted || battlePaused) return;
            
            moveShipsIntoBattle();
            handleCombat();
            
            battleTime += battleSpeed * 16; // 16ms per frame at 1x speed
            updateBattleStatus();
            
            checkBattleEnd();
            
            setTimeout(simulateBattle, 16); // ~60fps
        }
        
        function moveShipsIntoBattle() {
            const centerLat = BATTLE_COORDS.lat;
            const centerLng = BATTLE_COORDS.lng;
            
            ships.forEach(ship => {
                if (ship.sunk) return;
                
                if (ship.fleet === 'british') {
                    // British ships attack in two columns
                    const targetLat = centerLat + (Math.random() - 0.5) * 0.02;
                    const targetLng = centerLng + 0.01;
                    
                    const latDiff = targetLat - ship.lat;
                    const lngDiff = targetLng - ship.lng;
                    
                    ship.lat += latDiff * 0.001 * battleSpeed;
                    ship.lng += lngDiff * 0.001 * battleSpeed;
                    ship.angle = Math.atan2(lngDiff, latDiff) * (180 / Math.PI) + 270;
                } else {
                    // Franco-Spanish line formation
                    const targetLat = centerLat + (Math.random() - 0.5) * 0.01;
                    const targetLng = centerLng - 0.01;
                    
                    const latDiff = targetLat - ship.lat;
                    const lngDiff = targetLng - ship.lng;
                    
                    ship.lat += latDiff * 0.0005 * battleSpeed;
                    ship.lng += lngDiff * 0.0005 * battleSpeed;
                    ship.angle = Math.atan2(lngDiff, latDiff) * (180 / Math.PI) + 90;
                }
            });
            
            updateShipPositions();
        }
        
        function handleCombat() {
            ships.forEach(ship => {
                if (ship.sunk) return;
                
                // Find nearby enemy ships
                const enemies = ships.filter(s => 
                    !s.sunk && 
                    s.fleet !== ship.fleet && 
                    Math.abs(s.lat - ship.lat) < 0.008 && 
                    Math.abs(s.lng - ship.lng) < 0.008
                );
                
                if (enemies.length > 0) {
                    ship.inCombat = true;
                    const target = enemies[0]; // Engage closest enemy
                    ship.target = target;
                    
                    const distance = Math.hypot(
                        (target.lat - ship.lat) * 111000,
                        (target.lng - ship.lng) * 111000 * Math.cos(ship.lat * Math.PI / 180)
                    );
                    
                    const reloadTime = 3000 - (ship.guns * 10); // Faster reload for more guns
                    
                    if (battleTime - ship.lastFired > reloadTime && distance < 500) {
                        fireCannons(ship, target);
                        ship.lastFired = battleTime;
                    }
                } else {
                    ship.inCombat = false;
                    ship.target = null;
                }
            });
        }
        
        function fireCannons(attacker, target) {
            const distance = Math.hypot(
                (target.lat - attacker.lat) * 111000,
                (target.lng - attacker.lng) * 111000 * Math.cos(attacker.lat * Math.PI / 180)
            );
            
            const accuracy = Math.max(0.2, 1 - (distance / 600)) * (attacker.morale / 100);
            
            // Play cannon sound
            playAudioFile('cannon');
            
            // Create visual effect
            createCannonEffect(attacker, target);
            
            // Apply damage if hit
            if (Math.random() < accuracy) {
                const baseDamage = (attacker.guns / 8) + Math.random() * 15;
                const damage = baseDamage * (distance < 300 ? 1.5 : 1);
                
                target.health -= damage;
                target.damage += damage;
                target.morale = Math.max(10, target.morale - damage / 8);
                
                attacker.morale = Math.max(50, attacker.morale - 0.5);
                
                // Update health bar
                battleSvg.select(`[data-ship-id="${target.id}"] .health-fill`)
                    .transition()
                    .duration(200)
                    .attr('width', 20 * (target.health / 100))
                    .attr('fill', target.health > 70 ? '#4CAF50' : target.health > 30 ? '#FFC107' : '#F44336');
                
                if (target.health <= 0 && !target.sunk) {
                    sinkShip(target);
                }
            }
        }
        
        function createCannonEffect(attacker, target) {
            const attackerPoint = latLngToPoint(attacker.lat, attacker.lng);
            const targetPoint = latLngToPoint(target.lat, target.lng);
            
            if (!attackerPoint || !targetPoint) return;
            
            const effectGroup = battleSvg.append('g').attr('class', 'cannon-fire');
            
            // Muzzle flash
            effectGroup.append('circle')
                .attr('cx', attackerPoint.x)
                .attr('cy', attackerPoint.y)
                .attr('r', 3)
                .attr('class', 'muzzle-flash')
                .transition()
                .duration(150)
                .attr('r', 12)
                .style('opacity', 0)
                .remove();
            
            // Cannonball
            effectGroup.append('circle')
                .attr('cx', attackerPoint.x)
                .attr('cy', attackerPoint.y)
                .attr('r', 2)
                .attr('class', 'cannonball')
                .transition()
                .duration(400)
                .attr('cx', targetPoint.x + (Math.random() - 0.5) * 30)
                .attr('cy', targetPoint.y + (Math.random() - 0.5) * 30)
                .remove();
            
            // Smoke
            effectGroup.append('ellipse')
                .attr('cx', attackerPoint.x)
                .attr('cy', attackerPoint.y)
                .attr('rx', 0)
                .attr('ry', 0)
                .attr('class', 'smoke')
                .transition()
                .duration(1500)
                .attr('rx', 15)
                .attr('ry', 10)
                .style('opacity', 0)
                .remove();
        }
        
        function sinkShip(ship) {
            ship.sunk = true;
            casualties++;
            
            playAudioFile('explosion');
            
            const shipPoint = latLngToPoint(ship.lat, ship.lng);
            if (!shipPoint) return;
            
            // Explosion effect
            const explosion = battleSvg.append('g').attr('class', 'explosion');
            
            explosion.append('circle')
                .attr('cx', shipPoint.x)
                .attr('cy', shipPoint.y)
                .attr('r', 0)
                .attr('fill', '#FF4500')
                .transition()
                .duration(800)
                .attr('r', 30)
                .style('opacity', 0)
                .remove();
            
            // Debris
            for (let i = 0; i < 6; i++) {
                explosion.append('rect')
                    .attr('x', shipPoint.x)
                    .attr('y', shipPoint.y)
                    .attr('width', 2)
                    .attr('height', 6)
                    .attr('fill', '#8B4513')
                    .transition()
                    .duration(1500)
                    .attr('x', shipPoint.x + (Math.random() - 0.5) * 60)
                    .attr('y', shipPoint.y + Math.random() * 40)
                    .style('opacity', 0)
                    .remove();
            }
            
            // Sink ship animation
            battleSvg.select(`[data-ship-id="${ship.id}"]`)
                .transition()
                .duration(2000)
                .style('opacity', 0.3)
                .attr('transform', d => `translate(${d.screenX}, ${d.screenY + 20}) scale(0.8) rotate(${d.angle + 30})`);
            
            if (ship.name === "San Ildefonso") {
                updateBattleStatus("San Ildefonso has been sunk! ⚓");
            }
        }
        
        function updateBattleStatus(customMessage) {
            if (customMessage) {
                document.getElementById('battle-status').textContent = customMessage;
                return;
            }
            
            const minutes = Math.floor(battleTime / 60000);
            const hours = 6 + Math.floor(minutes / 60);
            const displayMinutes = minutes % 60;
            
            document.getElementById('time').textContent = 
                `Time: ${hours.toString().padStart(2, '0')}:${displayMinutes.toString().padStart(2, '0')} ${hours >= 12 ? 'PM' : 'AM'}`;
            document.getElementById('casualties').textContent = `Ships lost: ${casualties}`;
            
            // Update San Ildefonso status
            const sanIldefonso = ships.find(s => s.name === "San Ildefonso");
            if (sanIldefonso && !sanIldefonso.sunk) {
                let status = `San Ildefonso: ${Math.round(sanIldefonso.health)}% hull integrity`;
                if (sanIldefonso.inCombat) {
                    status += " - ENGAGING ENEMY! 🔥";
                }
                if (sanIldefonso.health < 30) {
                    status += " - CRITICAL DAMAGE! ⚠️";
                }
                document.getElementById('san-ildefonso-status').innerHTML = `<strong>${status}</strong>`;
            }
        }
        
        function checkBattleEnd() {
            const totalShips = ships.length;
            const sunkShips = ships.filter(s => s.sunk).length;
            
            if (sunkShips > totalShips * 0.4 || battleTime > 1800000) { // 30 minutes
                battleStarted = false;
                
                const britishLosses = ships.filter(s => s.fleet === 'british' && s.sunk).length;
                const allyLosses = ships.filter(s => (s.fleet === 'spanish' || s.fleet === 'french') && s.sunk).length;
                
                if (allyLosses > britishLosses) {
                    updateBattleStatus("Battle concluded - British victory! Nelson's tactics triumph.");
                } else {
                    updateBattleStatus("Battle concluded - Tactical stalemate achieved.");
                }
            }
        }
        
        // Map event listeners
        google.maps.event.addDomListener(window, 'load', () => {
            // Update ship positions when map moves
            map.addListener('bounds_changed', () => {
                setTimeout(updateShipPositions, 100);
            });
            
            map.addListener('zoom_changed', () => {
                updateShipScale();
            });
        });
        
        // Initialize when page loads
        detectMobile();
    </script>
</body>
</html>