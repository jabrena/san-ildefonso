<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Battle of Trafalgar - Historical Naval Battle Simulation</title>
    
    <!-- OpenLayers CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    
    <!-- D3.js for ship animations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif;
            overflow: hidden;
            background: #1a237e;
            touch-action: none;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .battle-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .battle-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1001;
            max-width: 350px;
            pointer-events: auto;
            border: 2px solid #8B4513;
        }
        
        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1001;
            pointer-events: auto;
            border: 2px solid #8B4513;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1001;
            pointer-events: auto;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .control-btn {
            background: linear-gradient(145deg, #8B4513, #654321);
            color: white;
            border: 2px solid #A0522D;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            user-select: none;
        }
        
        .control-btn:hover, .control-btn:active {
            background: linear-gradient(145deg, #A0522D, #8B4513);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1001;
            pointer-events: auto;
        }
        
        .zoom-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 2px solid #8B4513;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .zoom-btn:hover, .zoom-btn:active {
            background: rgba(139, 69, 19, 0.8);
            transform: scale(1.1);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .battle-info, .legend {
                font-size: 12px;
                padding: 10px;
                max-width: 280px;
            }
            
            .controls {
                left: 10px;
                right: 10px;
                bottom: 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .control-row {
                justify-content: center;
                gap: 8px;
            }
            
            .control-btn {
                padding: 14px 18px;
                font-size: 13px;
                min-width: 120px;
                flex: 1;
            }
            
            .zoom-controls {
                right: 10px;
                gap: 10px;
            }
            
            .zoom-btn {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
        }
        
        @media (max-width: 480px) {
            .battle-info {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .legend {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 8px;
            }
        }
        
        /* Ship animations */
        .ship {
            pointer-events: auto;
            cursor: pointer;
        }
        
        .ship-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1002;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #8B4513;
            max-width: 250px;
        }
        
        /* Cannon effects */
        .cannon-fire {
            pointer-events: none;
        }
        
        .muzzle-flash {
            fill: #FFD700;
            filter: blur(1px);
        }
        
        .cannonball {
            fill: #2F4F4F;
            stroke: #1a1a1a;
            stroke-width: 1;
        }
        
        .smoke {
            fill: #696969;
            opacity: 0.7;
        }
        
        .explosion {
            pointer-events: none;
        }
        
        .water-splash {
            fill: none;
            stroke: rgba(255, 255, 255, 0.8);
            stroke-width: 2;
        }
        
        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a237e, #3f51b5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Audio prompt animation */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(218, 165, 32, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(218, 165, 32, 0); }
            100% { box-shadow: 0 0 0 0 rgba(218, 165, 32, 0); }
        }
        
        .audio-prompt {
            animation: pulse 2s infinite;
        }
        
        /* Journey path animation */
        .journey-path {
            fill: none;
            stroke: rgba(255, 215, 0, 0.6);
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            animation: dash 2s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -15;
            }
        }
        
        /* Custom marker styles */
        .marker-battle {
            width: 30px;
            height: 30px;
            background: #ff4444;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            font-weight: bold;
        }
        
        .marker-port {
            width: 24px;
            height: 24px;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }
        
        .marker-spanish { background: #C41E3A; }
        .marker-french { background: #0055A4; }
        .marker-british { background: #012169; }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <h2>Loading Battle of Trafalgar</h2>
        <p>Preparing historical naval simulation...</p>
    </div>

    <div id="map"></div>
    
    <div class="battle-overlay">
        <div class="battle-info">
            <h3>Battle of Trafalgar - October 21, 1805</h3>
            <div id="battle-status">Fleets anchored in home waters, awaiting orders...</div>
            <div id="san-ildefonso-status"><strong>San Ildefonso:</strong> 74-gun Spanish ship of the line ready</div>
            <div id="casualties">Ships lost: 0</div>
            <div id="time">Time: 06:00 AM, October 21st, 1805</div>
            <div id="weather">Wind: Light SW breeze, 10 knots</div>
            <div id="coordinates">Battle Zone: 36°11'N, 6°02'W (Off Cape Trafalgar)</div>
            <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                Historical Fleet Count: British 27 ships | Franco-Spanish Combined 33 ships
            </div>
        </div>
        
        <div class="legend">
            <h4>Fleet Legend</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #C41E3A;"></div>
                <span>Spanish Fleet</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #0055A4;"></div>
                <span>French Fleet</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #012169;"></div>
                <span>British Fleet</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD700;"></div>
                <span>San Ildefonso (Focus)</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <button class="control-btn" id="startJourneyBtn" onclick="startJourney()">Begin Journey</button>
                <button class="control-btn" id="startBattleBtn" onclick="startBattle()" disabled>Start Battle</button>
                <button class="control-btn" onclick="pauseBattle()">Pause</button>
                <button class="control-btn" onclick="resetBattle()">Reset</button>
            </div>
            <div class="control-row">
                <button class="control-btn" onclick="focusOnSanIldefonso()">Focus San Ildefonso</button>
                <button class="control-btn" onclick="toggleSpeed()" id="speedBtn">Speed: 1x</button>
                <button class="control-btn" onclick="toggleSound()" id="soundBtn">Sound: ON</button>
            </div>
        </div>
        
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="zoomOut()">−</button>
        </div>
        
        <div class="ship-tooltip" id="tooltip"></div>
        
        <svg class="battle-overlay" id="battle-svg" width="100%" height="100%"></svg>
    </div>

    <script>
        // Global variables
        let map, view, battleSvg, ships = [], cannonFires = [], 
            battleStarted = false, battlePaused = false, journeyStarted = false,
            battleTime = 0, casualties = 0, battleSpeed = 1,
            audioContext, soundEnabled = true, audioInitialized = false, 
            isMobile = false, audioUnlocked = false;
        
        // Battle coordinates (off Cape Trafalgar) - Historical location in international waters
        const BATTLE_COORDS = [-6.033, 36.183]; // [longitude, latitude] for OpenLayers - Accurately off Cape Trafalgar
        
        // Home ports - moved to sea positions near the actual ports
        const HOME_PORTS = {
            spanish: { coords: [-6.3420, 36.4897], name: "Cadiz Bay" }, // Positioned in Cadiz Bay, in the sea
            french: { coords: [5.2898, 43.2565], name: "Toulon Harbor" }, // Positioned in Toulon Harbor, in the sea  
            british: { coords: [-1.0512, 50.7684], name: "Spithead" } // Positioned at Spithead anchorage, in the sea
        };

        // Maritime waypoints for realistic sea routes - ships follow these to avoid land
        const MARITIME_ROUTES = {
            spanish: [
                [-6.3420, 36.4897], // Start: Cadiz Bay
                [-6.3120, 36.3497], // Southwest of Cadiz
                [-6.033, 36.183]    // Battle location (corrected coordinates)
            ],
            french: [
                [5.2898, 43.2565],   // Start: Toulon Harbor
                [4.8000, 42.8000],   // Southwest of Toulon, staying in Mediterranean
                [3.5000, 42.0000],   // West of Corsica, in open waters
                [1.5000, 41.5000],   // East of Balearic Islands, in deep water
                [-0.5000, 40.5000],  // Mediterranean waters, east of Spanish coast
                [-2.5000, 39.5000],  // Mediterranean waters, southeast of Spanish coast
                [-4.0000, 38.0000],  // Atlantic waters, south of Portuguese coast
                [-5.5000, 37.0000],  // Atlantic approach, southwest of Portugal
                [-6.033, 36.183]     // Battle location (corrected coordinates, off Cape Trafalgar)
            ],
            british: [
                [-1.0512, 50.7684],  // Start: Spithead
                [-2.0000, 49.5000],  // West of Portsmouth
                [-3.5000, 48.0000],  // Bay of Biscay
                [-5.0000, 46.0000],  // Deep Atlantic
                [-6.5000, 44.0000],  // Northwest of Spain
                [-7.0000, 42.0000],  // West of Galicia
                [-7.5000, 40.0000],  // West of Portugal
                [-7.0000, 38.0000],  // Southwest of Portugal
                [-6.5000, 37.0000],  // Approach to Gibraltar
                [-6.033, 36.183]     // Battle location (corrected coordinates, off Cape Trafalgar)
            ]
        };
        
        // Historical ship data - Based on actual Battle of Trafalgar fleet compositions
        const fleetData = {
            spanish: [
                { name: "San Ildefonso", type: "Ship of the Line", guns: 74, flagship: true, crew: 640 },
                { name: "Santísima Trinidad", type: "First Rate", guns: 130, crew: 1048 },
                { name: "Santa Ana", type: "First Rate", guns: 112, crew: 810 },
                { name: "Principe de Asturias", type: "First Rate", guns: 112, flagship: true, crew: 810 },
                { name: "San Juan Nepomuceno", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "San Justo", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "San Leandro", type: "Ship of the Line", guns: 64, crew: 520 },
                { name: "Monarca", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Neptuno", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "Bahama", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "San Francisco de Asís", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Argonauta", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "Montañés", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Rayo", type: "First Rate", guns: 100, crew: 800 },
                { name: "San Augustín", type: "Ship of the Line", guns: 74, crew: 640 }
            ],
            french: [
                { name: "Bucentaure", type: "Ship of the Line", guns: 80, flagship: true, crew: 690 },
                { name: "Redoutable", type: "Ship of the Line", guns: 74, crew: 643 },
                { name: "Neptune", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "Fougueux", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Indomptable", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "Intrépide", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Aigle", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Achille", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Berwick", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Algésiras", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Héros", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Pluton", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Swiftsure", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Argonaute", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Formidable", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "Duguay-Trouin", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Mont-Blanc", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "Scipion", type: "Ship of the Line", guns: 74, crew: 640 }
            ],
            british: [
                { name: "HMS Victory", type: "First Rate", guns: 100, flagship: true, crew: 820 },
                { name: "HMS Royal Sovereign", type: "First Rate", guns: 100, flagship: true, crew: 800 },
                { name: "HMS Temeraire", type: "Ship of the Line", guns: 98, crew: 750 },
                { name: "HMS Neptune", type: "Ship of the Line", guns: 98, crew: 750 },
                { name: "HMS Britannia", type: "First Rate", guns: 100, crew: 800 },
                { name: "HMS Dreadnought", type: "Ship of the Line", guns: 98, crew: 750 },
                { name: "HMS Prince", type: "Ship of the Line", guns: 98, crew: 750 },
                { name: "HMS Tonnant", type: "Ship of the Line", guns: 80, crew: 690 },
                { name: "HMS Conqueror", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Leviathan", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Ajax", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Orion", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Minotaur", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Spartiate", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Belleisle", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Mars", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Bellerophon", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Colossus", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Achille", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Revenge", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Swiftsure", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Defiance", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Thunderer", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Defence", type: "Ship of the Line", guns: 74, crew: 640 },
                { name: "HMS Agamemnon", type: "Ship of the Line", guns: 64, crew: 520 },
                { name: "HMS Africa", type: "Ship of the Line", guns: 64, crew: 520 },
                { name: "HMS Polyphemus", type: "Ship of the Line", guns: 64, crew: 520 }
            ]
        };
        
        // Detect mobile devices
        function detectMobile() {
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);
        }
        
        // Initialize OpenLayers Map
        function initMap() {
            // Create view centered on battle location
            view = new ol.View({
                center: ol.proj.fromLonLat(BATTLE_COORDS),
                zoom: 8,
                minZoom: 3,
                maxZoom: 18
            });
            
            // Create satellite/terrain layer
            const satelliteLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attributions: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                })
            });
            
            // Create vector layer for markers
            const vectorSource = new ol.source.Vector();
            const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: function(feature) {
                    return new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: feature.get('type') === 'battle' ? 15 : 12,
                            fill: new ol.style.Fill({
                                color: feature.get('color')
                            }),
                            stroke: new ol.style.Stroke({
                                color: '#fff',
                                width: 2
                            })
                        }),
                        text: new ol.style.Text({
                            text: feature.get('symbol'),
                            fill: new ol.style.Fill({
                                color: '#fff'
                            }),
                            font: 'bold 14px Arial'
                        })
                    });
                }
            });
            
            // Create custom interactions array for OpenLayers v8
            const interactions = [];
            
            // Add drag pan interaction
            interactions.push(new ol.interaction.DragPan());
            
            // Add mouse wheel zoom conditionally for desktop
            if (!isMobile) {
                interactions.push(new ol.interaction.MouseWheelZoom());
            }
            
            // Add pinch zoom conditionally for mobile
            if (isMobile) {
                interactions.push(new ol.interaction.PinchZoom());
            }
            
            // Add drag rotate (but not double-click zoom as it was disabled)
            interactions.push(new ol.interaction.DragRotate());
            
            // Create map
            map = new ol.Map({
                target: 'map',
                layers: [satelliteLayer, vectorLayer],
                view: view,
                interactions: interactions,
                controls: [] // Remove default controls
            });
            
            // Add historical markers
            addHistoricalMarkers(vectorSource);
            
            // Initialize battle overlay
            initBattleOverlay();
            
            // Add map event listeners
            addMapEventListeners();
            
            // Hide loading screen
            document.getElementById('loadingScreen').style.display = 'none';
        }
        
        function addHistoricalMarkers(vectorSource) {
            // Battle location marker
            const battleFeature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat(BATTLE_COORDS)),
                type: 'battle',
                color: '#ff4444',
                symbol: '⚔',
                name: 'Battle of Trafalgar - October 21, 1805'
            });
            vectorSource.addFeature(battleFeature);
            
            // Home port markers
            Object.entries(HOME_PORTS).forEach(([fleet, port]) => {
                const color = fleet === 'spanish' ? '#C41E3A' : fleet === 'french' ? '#0055A4' : '#012169';
                const portFeature = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat(port.coords)),
                    type: 'port',
                    color: color,
                    symbol: '⚓',
                    name: `${port.name} - ${fleet.charAt(0).toUpperCase() + fleet.slice(1)} Home Port`
                });
                vectorSource.addFeature(portFeature);
            });
        }
        
        function addMapEventListeners() {
            // Update ship positions when map moves or zooms
            map.on('moveend', updateShipPositions);
            map.on('postrender', updateShipPositions);
            
            // Handle mobile touch controls
            if (isMobile) {
                let lastTouchTime = 0;
                map.getViewport().addEventListener('touchend', function(e) {
                    const now = Date.now();
                    if (now - lastTouchTime < 300) {
                        // Double tap to zoom
                        const coordinate = map.getEventCoordinate(e.changedTouches[0]);
                        view.animate({
                            center: coordinate,
                            zoom: view.getZoom() + 1,
                            duration: 300
                        });
                    }
                    lastTouchTime = now;
                });
            }
        }
        
        function initBattleOverlay() {
            detectMobile();
            initAudio();
            battleSvg = d3.select("#battle-svg");
            prepareShips();
            updateBattleStatus();
        }
        
        // Audio system initialization
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (isMobile) {
                    addMobileAudioHandlers();
                } else {
                    audioInitialized = true;
                    audioUnlocked = true;
                }
            } catch (e) {
                console.warn("Audio not supported");
                soundEnabled = false;
            }
            updateSoundButton();
        }
        
        function addMobileAudioHandlers() {
            const unlockAudio = () => {
                if (audioContext && !audioUnlocked) {
                    const source = audioContext.createBufferSource();
                    const buffer = audioContext.createBuffer(1, 1, 22050);
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start(0);
                    
                    audioContext.resume().then(() => {
                        audioUnlocked = true;
                        audioInitialized = true;
                        updateSoundButton();
                    });
                    
                    document.removeEventListener('touchstart', unlockAudio);
                    document.removeEventListener('click', unlockAudio);
                }
            };
            
            document.addEventListener('touchstart', unlockAudio, false);
            document.addEventListener('click', unlockAudio, false);
        }
        
        function playCannonSound() {
            if (!audioContext || !audioUnlocked) return;
            
            const duration = 1.2;
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration;
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < length; i++) {
                const t = i / sampleRate;
                let sample = 0;
                
                if (t < 0.1) {
                    const attack = Math.exp(-t * 30);
                    sample += attack * (Math.random() * 2 - 1) * 0.5;
                    sample += attack * Math.sin(2 * Math.PI * 150 * t) * 0.3;
                } else {
                    const decay = Math.exp(-(t - 0.1) * 4);
                    sample += decay * Math.sin(2 * Math.PI * 80 * t) * 0.2;
                }
                
                data[i] = sample;
            }
            
            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();
            source.buffer = buffer;
            gainNode.gain.value = 0.4;
            
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start();
        }
        
        function playExplosionSound() {
            if (!audioContext || !audioUnlocked) return;
            
            const duration = 2.0;
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration;
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < length; i++) {
                const t = i / sampleRate;
                let sample = 0;
                
                if (t < 0.2) {
                    const blast = Math.exp(-t * 15);
                    sample += blast * (Math.random() * 2 - 1) * 0.8;
                    sample += blast * Math.sin(2 * Math.PI * 120 * t) * 0.4;
                } else {
                    const rumble = Math.exp(-(t - 0.2) * 3);
                    sample += rumble * Math.sin(2 * Math.PI * 40 * t) * 0.3;
                    sample += rumble * (Math.random() * 2 - 1) * 0.1;
                }
                
                data[i] = sample;
            }
            
            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();
            source.buffer = buffer;
            gainNode.gain.value = 0.6;
            
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start();
        }
        
        // Standardized formation configuration for all fleets
        // This ensures consistent formations across Spanish, French, and British fleets
        // Applied to: initial positioning, movement formations, battle formations, and combat ranges
        const FORMATION_CONFIG = {
            radius: 0.015,              // Base radius for formation spread
            radiusVariation: 0.6,       // Variation factor (0.7 + random * 0.6)
            baseVariation: 0.7,         // Base variation factor
            pattern: 'circular'         // Formation pattern type
        };
        
        function prepareShips() {
            ships = [];
            let id = 0;
            
            Object.keys(fleetData).forEach(fleet => {
                const homePort = HOME_PORTS[fleet];
                fleetData[fleet].forEach((shipData, index) => {
                    let initialCoords;
                    let initialAngle;
                    
                    if (fleet === 'british') {
                        // British fleet starts west of Cape Trafalgar in formation
                        const nelsonShips = ['HMS Victory', 'HMS Temeraire', 'HMS Neptune', 'HMS Leviathan', 'HMS Conqueror', 'HMS Britannia', 'HMS Ajax', 'HMS Agamemnon', 'HMS Orion', 'HMS Minotaur', 'HMS Spartiate', 'HMS Africa'];
                        const collingwoodShips = ['HMS Royal Sovereign', 'HMS Belleisle', 'HMS Mars', 'HMS Tonnant', 'HMS Bellerophon', 'HMS Colossus', 'HMS Achille', 'HMS Revenge', 'HMS Defiance', 'HMS Dreadnought', 'HMS Thunderer', 'HMS Swiftsure', 'HMS Polyphemus', 'HMS Defence', 'HMS Prince'];
                        
                        if (nelsonShips.includes(shipData.name)) {
                            const columnIndex = nelsonShips.indexOf(shipData.name);
                            initialCoords = [
                                homePort.coords[0] - 0.005, // West of normal position
                                homePort.coords[1] + 0.01 + (columnIndex * 0.002) // Nelson's column formation
                            ];
                            initialAngle = 90; // Facing east toward enemy
                        } else if (collingwoodShips.includes(shipData.name)) {
                            const columnIndex = collingwoodShips.indexOf(shipData.name);
                            initialCoords = [
                                homePort.coords[0] - 0.008, // Further west
                                homePort.coords[1] - 0.005 + (columnIndex * 0.002) // Collingwood's column formation
                            ];
                            initialAngle = 90; // Facing east toward enemy
                        } else {
                            // Fallback for any additional British ships
                            const angle = (index / fleetData[fleet].length) * 2 * Math.PI;
                            const radiusVariation = FORMATION_CONFIG.radius * 
                                (FORMATION_CONFIG.baseVariation + Math.random() * FORMATION_CONFIG.radiusVariation);
                            initialCoords = [
                                homePort.coords[0] + Math.cos(angle) * radiusVariation,
                                homePort.coords[1] + Math.sin(angle) * radiusVariation
                            ];
                            initialAngle = Math.random() * 360;
                        }
                    } else {
                        // Franco-Spanish Combined Fleet starts in line formation off Cadiz
                        const totalShips = Object.values(fleetData).flat().filter(s => s !== shipData && (s.fleet === 'spanish' || s.fleet === 'french')).length + index;
                        const linePosition = (index / fleetData[fleet].length) - 0.5;
                        
                        initialCoords = [
                            homePort.coords[0] + 0.005, // East of port
                            homePort.coords[1] + (linePosition * 0.025) // Line formation
                        ];
                        initialAngle = 180; // Facing south initially
                    }
                    
                    ships.push({
                        id: id++,
                        ...shipData,
                        fleet: fleet,
                        health: 100,
                        sunk: false,
                        angle: initialAngle,
                        inCombat: false,
                        target: null,
                        lastFired: 0,
                        morale: 100,
                        damage: 0,
                        coords: initialCoords,
                        // Journey state with maritime route following
                        journeyProgress: 0,
                        currentWaypoint: 0,
                        route: MARITIME_ROUTES[fleet],
                        atBattle: false
                    });
                });
            });
            
            drawShips();
        }
        
        function drawShips() {
            // Clear existing ships
            battleSvg.selectAll('.ship').remove();
            
            const shipGroups = battleSvg.selectAll('.ship')
                .data(ships, d => d.id)
                .enter()
                .append('g')
                .attr('class', 'ship')
                .attr('data-ship-id', d => d.id)
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                    focusOnShip(d);
                })
                .on('mouseover', function(event, d) {
                    showTooltip(event, d);
                })
                .on('mouseout', function() {
                    hideTooltip();
                });
            
            // Ship hulls
            shipGroups.append('ellipse')
                .attr('rx', d => d.guns > 100 ? 25 : d.guns > 80 ? 20 : 16)
                .attr('ry', d => d.guns > 100 ? 8 : d.guns > 80 ? 6 : 5)
                .attr('fill', d => {
                    if (d.name === "San Ildefonso") return "#FFD700";
                    return d.fleet === "spanish" ? "#C41E3A" : 
                           d.fleet === "french" ? "#0055A4" : "#012169";
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 1);
            
            // Ship names
            shipGroups.append('text')
                .attr('y', -20)
                .attr('text-anchor', 'middle')
                .attr('font-size', '8px')
                .attr('font-weight', 'bold')
                .attr('fill', 'white')
                .attr('stroke', 'black')
                .attr('stroke-width', 0.5)
                .text(d => d.name.length > 15 ? d.name.substring(0, 12) + '...' : d.name);
            
            // Health bars
            const healthBars = shipGroups.append('g').attr('class', 'health-bar');
            
            healthBars.append('rect')
                .attr('x', -10)
                .attr('y', 15)
                .attr('width', 20)
                .attr('height', 3)
                .attr('fill', '#333')
                .attr('stroke', '#fff')
                .attr('stroke-width', 0.5);
                
            healthBars.append('rect')
                .attr('x', -10)
                .attr('y', 15)
                .attr('width', d => 20 * (d.health / 100))
                .attr('height', 3)
                .attr('fill', d => d.health > 70 ? '#4CAF50' : d.health > 30 ? '#FFC107' : '#F44336')
                .attr('class', 'health-fill');
            
            updateShipPositions();
        }
        
        function updateShipPositions() {
            ships.forEach(ship => {
                const pixel = map.getPixelFromCoordinate(ol.proj.fromLonLat(ship.coords));
                if (pixel) {
                    ship.screenX = pixel[0];
                    ship.screenY = pixel[1];
                }
            });
            
            battleSvg.selectAll('.ship')
                .attr('transform', d => `translate(${d.screenX || 0}, ${d.screenY || 0}) rotate(${d.angle || 0})`);
        }
        
        // Control functions
        function startJourney() {
            if (journeyStarted) return;
            
            journeyStarted = true;
            document.getElementById('startJourneyBtn').disabled = true;
            document.getElementById('startJourneyBtn').textContent = 'Journey In Progress...';
            
            updateBattleStatus("Ships departing from home waters...");
            
            // Draw maritime routes
            drawMaritimeRoutes();
            
            // Animate ships to battle location
            animateJourney();
        }
        
        function drawMaritimeRoutes() {
            // Clear any existing paths
            battleSvg.selectAll('.journey-path').remove();
            
            Object.entries(MARITIME_ROUTES).forEach(([fleet, route]) => {
                const color = fleet === 'spanish' ? '#C41E3A' : fleet === 'french' ? '#0055A4' : '#012169';
                
                // Convert route coordinates to screen pixels
                const pathData = route.map(coords => {
                    const pixel = map.getPixelFromCoordinate(ol.proj.fromLonLat(coords));
                    return pixel ? [pixel[0], pixel[1]] : [0, 0];
                }).filter(pixel => pixel[0] !== 0 || pixel[1] !== 0);
                
                if (pathData.length > 1) {
                    const pathString = pathData.reduce((path, point, index) => {
                        return path + (index === 0 ? `M ${point[0]} ${point[1]}` : ` L ${point[0]} ${point[1]}`);
                    }, '');
                    
                    battleSvg.append('path')
                        .attr('d', pathString)
                        .attr('class', 'journey-path')
                        .attr('fleet', fleet)
                        .style('stroke', color)
                        .style('stroke-width', '2')
                        .style('fill', 'none')
                        .style('opacity', '0.6')
                        .style('stroke-dasharray', '8,4')
                        .style('pointer-events', 'none');
                }
            });
            
            // Update route paths when map moves
            map.on('moveend', updateMaritimeRoutes);
            map.on('postrender', updateMaritimeRoutes);
        }
        
        function updateMaritimeRoutes() {
            battleSvg.selectAll('.journey-path').each(function() {
                const pathElement = d3.select(this);
                const fleet = pathElement.attr('fleet');
                const route = MARITIME_ROUTES[fleet];
                
                if (route) {
                    const pathData = route.map(coords => {
                        const pixel = map.getPixelFromCoordinate(ol.proj.fromLonLat(coords));
                        return pixel ? [pixel[0], pixel[1]] : [0, 0];
                    }).filter(pixel => pixel[0] !== 0 || pixel[1] !== 0);
                    
                    if (pathData.length > 1) {
                        const pathString = pathData.reduce((path, point, index) => {
                            return path + (index === 0 ? `M ${point[0]} ${point[1]}` : ` L ${point[0]} ${point[1]}`);
                        }, '');
                        
                        pathElement.attr('d', pathString);
                    }
                }
            });
        }
        
        function animateJourney() {
            const journeyDuration = 12000; // 12 seconds for more realistic journey time
            const startTime = Date.now();
            
            function updateJourney() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / journeyDuration, 1);
                
                ships.forEach(ship => {
                    if (ship.sunk) return;
                    
                    const route = ship.route;
                    const totalWaypoints = route.length - 1;
                    
                    // Calculate which segment of the route we're on
                    const routeProgress = progress * totalWaypoints;
                    const currentSegment = Math.floor(routeProgress);
                    const segmentProgress = routeProgress - currentSegment;
                    
                    // Get current and next waypoints
                    const currentWaypoint = route[Math.min(currentSegment, totalWaypoints - 1)];
                    const nextWaypoint = route[Math.min(currentSegment + 1, totalWaypoints)];
                    
                    // Interpolate between waypoints with smooth sailing physics
                    if (currentWaypoint && nextWaypoint) {
                        const lngDiff = nextWaypoint[0] - currentWaypoint[0];
                        const latDiff = nextWaypoint[1] - currentWaypoint[1];
                        
                        // Add standardized formation spread to prevent ships from overlapping
                        const fleetIndex = ships.filter(s => s.fleet === ship.fleet).indexOf(ship);
                        const fleetSize = ships.filter(s => s.fleet === ship.fleet).length;
                        
                        // Use standardized formation spread for all fleets
                        const formationSpread = FORMATION_CONFIG.radius * 0.533; // Consistent with harbor formation
                        
                        const formationOffset = [
                            Math.sin((fleetIndex / fleetSize) * Math.PI * 2) * formationSpread,
                            Math.cos((fleetIndex / fleetSize) * Math.PI * 2) * formationSpread * 0.5
                        ];
                        
                        // Smooth interpolation with slight course variation for realism
                        const courseVariation = Math.sin(Date.now() * 0.001 + ship.id) * 0.0005;
                        
                        ship.coords = [
                            currentWaypoint[0] + (lngDiff * segmentProgress) + formationOffset[0] + courseVariation,
                            currentWaypoint[1] + (latDiff * segmentProgress) + formationOffset[1]
                        ];
                        
                        // Update ship angle based on actual sailing direction
                        if (lngDiff !== 0 || latDiff !== 0) {
                            ship.angle = Math.atan2(lngDiff, latDiff) * (180 / Math.PI) + 90;
                        }
                        
                        // Update ship's current waypoint for status tracking
                        ship.currentWaypoint = currentSegment;
                    }
                });
                
                updateShipPositions();
                
                // Update status with more descriptive information
                const percentage = Math.round(progress * 100);
                let statusMessage = `Journey progress: ${percentage}% - `;
                
                if (progress < 0.3) {
                    statusMessage += "Fleets departing home waters...";
                } else if (progress < 0.7) {
                    statusMessage += "Ships sailing open seas, following maritime routes...";
                } else {
                    statusMessage += "British columns advancing to break the enemy line - Nelson's tactical masterstroke unfolds...";
                }
                
                updateBattleStatus(statusMessage);
                
                if (progress < 1) {
                    requestAnimationFrame(updateJourney);
                } else {
                    onJourneyComplete();
                }
            }
            
            updateJourney();
        }
        
        function onJourneyComplete() {
            ships.forEach(ship => {
                ship.atBattle = true;
            });
            
            document.getElementById('startBattleBtn').disabled = false;
            document.getElementById('startBattleBtn').classList.add('audio-prompt');
            updateBattleStatus("All fleets have arrived! Ready for battle!");
        }
        
        function startBattle() {
            if (!journeyStarted || battleStarted) return;
            
            // Enable audio context on user interaction
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // Mobile audio unlock
            if (isMobile && audioContext && !audioUnlocked) {
                const source = audioContext.createBufferSource();
                const buffer = audioContext.createBuffer(1, 1, 22050);
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start(0);
                
                audioContext.resume().then(() => {
                    audioUnlocked = true;
                    audioInitialized = true;
                    updateSoundButton();
                });
            }
            
            battleStarted = true;
            battlePaused = false;
            battleTime = 0;
            
            document.getElementById('startBattleBtn').classList.remove('audio-prompt');
            document.getElementById('startBattleBtn').disabled = true;
            
                            updateBattleStatus("Battle commenced! Nelson's two-column attack begins! The 'Nelson Touch' in action!");
            
            // Focus map on battle area
            view.animate({
                center: ol.proj.fromLonLat(BATTLE_COORDS),
                zoom: 12,
                duration: 1000
            });
            
            simulateBattle();
        }
        
        function pauseBattle() {
            battlePaused = !battlePaused;
            const btn = event.target;
            btn.textContent = battlePaused ? 'Resume' : 'Pause';
            updateBattleStatus(battlePaused ? "Battle paused" : "Battle resumed");
        }
        
        function resetBattle() {
            battleStarted = false;
            battlePaused = false;
            journeyStarted = false;
            battleTime = 0;
            casualties = 0;
            
            // Reset ships to their original standardized sea formations
            ships.forEach(ship => {
                const homePort = HOME_PORTS[ship.fleet];
                const index = ships.filter(s => s.fleet === ship.fleet).indexOf(ship);
                
                let resetCoords;
                let resetAngle;
                
                if (ship.fleet === 'british') {
                    // Reset British fleet to historical formation
                    const nelsonShips = ['HMS Victory', 'HMS Temeraire', 'HMS Neptune', 'HMS Leviathan', 'HMS Conqueror', 'HMS Britannia', 'HMS Ajax', 'HMS Agamemnon', 'HMS Orion', 'HMS Minotaur', 'HMS Spartiate', 'HMS Africa'];
                    const collingwoodShips = ['HMS Royal Sovereign', 'HMS Belleisle', 'HMS Mars', 'HMS Tonnant', 'HMS Bellerophon', 'HMS Colossus', 'HMS Achille', 'HMS Revenge', 'HMS Defiance', 'HMS Dreadnought', 'HMS Thunderer', 'HMS Swiftsure', 'HMS Polyphemus', 'HMS Defence', 'HMS Prince'];
                    
                    if (nelsonShips.includes(ship.name)) {
                        const columnIndex = nelsonShips.indexOf(ship.name);
                        resetCoords = [
                            homePort.coords[0] - 0.005,
                            homePort.coords[1] + 0.01 + (columnIndex * 0.002)
                        ];
                        resetAngle = 90;
                    } else if (collingwoodShips.includes(ship.name)) {
                        const columnIndex = collingwoodShips.indexOf(ship.name);
                        resetCoords = [
                            homePort.coords[0] - 0.008,
                            homePort.coords[1] - 0.005 + (columnIndex * 0.002)
                        ];
                        resetAngle = 90;
                    } else {
                        const angle = (index / fleetData[ship.fleet].length) * 2 * Math.PI;
                        const radiusVariation = FORMATION_CONFIG.radius * 
                            (FORMATION_CONFIG.baseVariation + Math.random() * FORMATION_CONFIG.radiusVariation);
                        resetCoords = [
                            homePort.coords[0] + Math.cos(angle) * radiusVariation,
                            homePort.coords[1] + Math.sin(angle) * radiusVariation
                        ];
                        resetAngle = Math.random() * 360;
                    }
                } else {
                    // Reset Franco-Spanish Combined Fleet to line formation
                    const linePosition = (index / fleetData[ship.fleet].length) - 0.5;
                    resetCoords = [
                        homePort.coords[0] + 0.005,
                        homePort.coords[1] + (linePosition * 0.025)
                    ];
                    resetAngle = 180;
                }
                
                ship.health = 100;
                ship.sunk = false;
                ship.inCombat = false;
                ship.target = null;
                ship.morale = 100;
                ship.damage = 0;
                ship.coords = resetCoords;
                ship.angle = resetAngle;
                ship.atBattle = false;
                ship.journeyProgress = 0;
                ship.currentWaypoint = 0;
                ship.route = MARITIME_ROUTES[ship.fleet];
            });
            
            // Reset UI
            document.getElementById('startJourneyBtn').disabled = false;
            document.getElementById('startJourneyBtn').textContent = 'Begin Journey';
            document.getElementById('startBattleBtn').disabled = true;
            document.getElementById('startBattleBtn').classList.remove('audio-prompt');
            document.querySelector('[onclick="pauseBattle()"]').textContent = 'Pause';
            
            // Clear effects and maritime routes
            battleSvg.selectAll('.cannon-fire').remove();
            battleSvg.selectAll('.explosion').remove();
            battleSvg.selectAll('.journey-path').remove();
            
            updateShipPositions();
            updateBattleStatus("Fleets anchored in home waters, awaiting orders...");
            
            // Reset map view
            view.animate({
                center: ol.proj.fromLonLat(BATTLE_COORDS),
                zoom: 8,
                duration: 1000
            });
        }
        
        function toggleSpeed() {
            battleSpeed = battleSpeed === 1 ? 2 : battleSpeed === 2 ? 4 : 1;
            document.getElementById('speedBtn').textContent = `Speed: ${battleSpeed}x`;
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            updateSoundButton();
        }
        
        function updateSoundButton() {
            const button = document.getElementById('soundBtn');
            if (button) {
                let buttonText = "Sound: ";
                button.classList.remove('audio-prompt');
                
                if (!audioContext) {
                    buttonText += "UNAVAILABLE";
                    button.style.background = "#555";
                } else if (isMobile && !audioUnlocked) {
                    buttonText += soundEnabled ? "TAP TO ENABLE" : "OFF";
                    button.style.background = soundEnabled ? "#DAA520" : "#555";
                    if (soundEnabled) {
                        button.classList.add('audio-prompt');
                    }
                } else {
                    buttonText += soundEnabled ? "ON" : "OFF";
                    button.style.background = soundEnabled ? "" : "#555";
                }
                button.textContent = buttonText;
            }
        }
        
        function focusOnSanIldefonso() {
            const sanIldefonso = ships.find(s => s.name === "San Ildefonso");
            if (sanIldefonso) {
                focusOnShip(sanIldefonso);
            }
        }
        
        function focusOnShip(ship) {
            view.animate({
                center: ol.proj.fromLonLat(ship.coords),
                zoom: 14,
                duration: 1000
            });
            
            // Highlight ship
            battleSvg.selectAll('.ship').style('opacity', 0.5);
            battleSvg.select(`[data-ship-id="${ship.id}"]`).style('opacity', 1);
            
            setTimeout(() => {
                battleSvg.selectAll('.ship').style('opacity', 1);
                view.animate({
                    zoom: 12,
                    duration: 1000
                });
            }, 3000);
        }
        
        function zoomIn() {
            const currentZoom = view.getZoom();
            view.animate({
                zoom: Math.min(currentZoom + 1, 18),
                duration: 300
            });
        }
        
        function zoomOut() {
            const currentZoom = view.getZoom();
            view.animate({
                zoom: Math.max(currentZoom - 1, 3),
                duration: 300
            });
        }
        
        function showTooltip(event, ship) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.innerHTML = `
                <strong>${ship.name}</strong><br/>
                Fleet: ${ship.fleet.charAt(0).toUpperCase() + ship.fleet.slice(1)}<br/>
                Type: ${ship.type}<br/>
                Guns: ${ship.guns}<br/>
                Crew: ${ship.crew}<br/>
                Health: ${Math.round(ship.health)}%<br/>
                Morale: ${Math.round(ship.morale)}%<br/>
                ${ship.flagship ? '<em>⭐ Flagship</em><br/>' : ''}
                ${ship.inCombat ? '<em>🔥 In Combat</em>' : ''}
            `;
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }
        
        function simulateBattle() {
            if (!battleStarted || battlePaused) return;
            
            moveShipsIntoBattle();
            handleCombat();
            
            battleTime += battleSpeed * 16; // 16ms per frame at 1x speed
            updateBattleStatus();
            
            checkBattleEnd();
            
            setTimeout(simulateBattle, 16); // ~60fps
        }
        
        function moveShipsIntoBattle() {
            ships.forEach(ship => {
                if (ship.sunk) return;
                
                // Ensure all movements stay well offshore (minimum distance from battle coordinates)
                const minDistanceFromShore = 0.005; // Keep ships at least this far from any potential land
                
                if (ship.fleet === 'british') {
                    // Historical Nelson's Two-Column Attack Formation
                    // Nelson's Column: Victory, Temeraire, Neptune, Leviathan, Conqueror, Britannia, Ajax, Agamemnon, Orion, Minotaur, Spartiate, Africa
                    // Collingwood's Column: Royal Sovereign, Belleisle, Mars, Tonnant, Bellerophon, Colossus, Achille, Revenge, Defiance, Dreadnought, Thunderer, Swiftsure, Polyphemus, Defence, Prince
                    
                    const nelsonShips = ['HMS Victory', 'HMS Temeraire', 'HMS Neptune', 'HMS Leviathan', 'HMS Conqueror', 'HMS Britannia', 'HMS Ajax', 'HMS Agamemnon', 'HMS Orion', 'HMS Minotaur', 'HMS Spartiate', 'HMS Africa'];
                    const collingwoodShips = ['HMS Royal Sovereign', 'HMS Belleisle', 'HMS Mars', 'HMS Tonnant', 'HMS Bellerophon', 'HMS Colossus', 'HMS Achille', 'HMS Revenge', 'HMS Defiance', 'HMS Dreadnought', 'HMS Thunderer', 'HMS Swiftsure', 'HMS Polyphemus', 'HMS Defence', 'HMS Prince'];
                    
                    const isNelsonColumn = nelsonShips.includes(ship.name);
                    const isCollingwoodColumn = collingwoodShips.includes(ship.name);
                    
                    if (isNelsonColumn) {
                        // Nelson's windward column - attacks center of enemy line
                        const columnIndex = nelsonShips.indexOf(ship.name);
                        const columnSpacing = 0.003; // Ship spacing in column
                        const targetCoords = [
                            BATTLE_COORDS[0] - 0.008, // West of battle zone
                            BATTLE_COORDS[1] + 0.005 + (columnIndex * columnSpacing) // Nelson's column north
                        ];
                        
                        const lngDiff = targetCoords[0] - ship.coords[0];
                        const latDiff = targetCoords[1] - ship.coords[1];
                        
                        const newLng = ship.coords[0] + (lngDiff * 0.001 * battleSpeed);
                        const newLat = ship.coords[1] + (latDiff * 0.001 * battleSpeed);
                        
                        if (newLng > -7.0 && newLat > 36.0 && newLat < 37.0) {
                            ship.coords[0] = newLng;
                            ship.coords[1] = newLat;
                            ship.angle = Math.atan2(lngDiff, latDiff) * (180 / Math.PI) + 90;
                        }
                    } else if (isCollingwoodColumn) {
                        // Collingwood's leeward column - attacks rear of enemy line
                        const columnIndex = collingwoodShips.indexOf(ship.name);
                        const columnSpacing = 0.003; // Ship spacing in column
                        const targetCoords = [
                            BATTLE_COORDS[0] - 0.012, // Further west than Nelson
                            BATTLE_COORDS[1] - 0.010 + (columnIndex * columnSpacing) // Collingwood's column south
                        ];
                        
                        const lngDiff = targetCoords[0] - ship.coords[0];
                        const latDiff = targetCoords[1] - ship.coords[1];
                        
                        const newLng = ship.coords[0] + (lngDiff * 0.001 * battleSpeed);
                        const newLat = ship.coords[1] + (latDiff * 0.001 * battleSpeed);
                        
                        if (newLng > -7.0 && newLat > 36.0 && newLat < 37.0) {
                            ship.coords[0] = newLng;
                            ship.coords[1] = newLat;
                            ship.angle = Math.atan2(lngDiff, latDiff) * (180 / Math.PI) + 90;
                        }
                    }
                } else {
                    // Franco-Spanish Combined Fleet - Traditional Line of Battle Formation
                    // Historically formed an imperfect arc due to poor coordination
                    
                    const alliedShips = ships.filter(s => s.fleet === 'spanish' || s.fleet === 'french');
                    const shipIndex = alliedShips.indexOf(ship);
                    const totalAlliedShips = alliedShips.length;
                    
                    // Create historical arc formation - poorly coordinated line
                    const arcLength = 0.04; // Total length of the arc
                    const arcCenter = BATTLE_COORDS[1];
                    const linePosition = (shipIndex / (totalAlliedShips - 1)) - 0.5; // -0.5 to 0.5
                    
                    // Historical arc formation with center ships pushed leeward
                    const arcCurvature = 0.008; // Amount of curvature in the line
                    const xOffset = Math.sin(linePosition * Math.PI) * arcCurvature;
                    
                    const targetCoords = [
                        BATTLE_COORDS[0] + 0.015 + xOffset, // East of battle zone, curved line
                        arcCenter + (linePosition * arcLength) // Spread along north-south arc
                    ];
                    
                    const lngDiff = targetCoords[0] - ship.coords[0];
                    const latDiff = targetCoords[1] - ship.coords[1];
                    
                    // Slower, more defensive movement - Combined Fleet was less maneuverable
                    const newLng = ship.coords[0] + (lngDiff * 0.0003 * battleSpeed);
                    const newLat = ship.coords[1] + (latDiff * 0.0003 * battleSpeed);
                    
                    // Keep Franco-Spanish fleet in safe waters off Cape Trafalgar
                    if (newLng < -6.0 && newLng > -6.5 && newLat > 36.0 && newLat < 37.0) {
                        ship.coords[0] = newLng;
                        ship.coords[1] = newLat;
                        ship.angle = Math.atan2(lngDiff, latDiff) * (180 / Math.PI) + 270;
                    }
                }
            });
            
            updateShipPositions();
        }
        
        function handleCombat() {
            ships.forEach(ship => {
                if (ship.sunk) return;
                
                // Find nearby enemy ships using standardized combat range
                const combatRange = FORMATION_CONFIG.radius * 0.533; // Consistent with formation spacing
                const enemies = ships.filter(s => 
                    !s.sunk && 
                    s.fleet !== ship.fleet && 
                    Math.abs(s.coords[0] - ship.coords[0]) < combatRange && 
                    Math.abs(s.coords[1] - ship.coords[1]) < combatRange
                );
                
                if (enemies.length > 0) {
                    ship.inCombat = true;
                    const target = enemies[0]; // Engage closest enemy
                    ship.target = target;
                    
                    const distance = Math.hypot(
                        (target.coords[0] - ship.coords[0]) * 111000 * Math.cos(ship.coords[1] * Math.PI / 180),
                        (target.coords[1] - ship.coords[1]) * 111000
                    );
                    
                    const reloadTime = 3000 - (ship.guns * 10); // Faster reload for more guns
                    
                    if (battleTime - ship.lastFired > reloadTime && distance < 500) {
                        fireCannons(ship, target);
                        ship.lastFired = battleTime;
                    }
                } else {
                    ship.inCombat = false;
                    ship.target = null;
                }
            });
        }
        
        function fireCannons(attacker, target) {
            const distance = Math.hypot(
                (target.coords[0] - attacker.coords[0]) * 111000 * Math.cos(attacker.coords[1] * Math.PI / 180),
                (target.coords[1] - attacker.coords[1]) * 111000
            );
            
            const accuracy = Math.max(0.2, 1 - (distance / 600)) * (attacker.morale / 100);
            
            // Play cannon sound
            if (soundEnabled) playCannonSound();
            
            // Create visual effect
            createCannonEffect(attacker, target);
            
            // Apply damage if hit
            if (Math.random() < accuracy) {
                const baseDamage = (attacker.guns / 8) + Math.random() * 15;
                const damage = baseDamage * (distance < 300 ? 1.5 : 1);
                
                target.health -= damage;
                target.damage += damage;
                target.morale = Math.max(10, target.morale - damage / 8);
                
                attacker.morale = Math.max(50, attacker.morale - 0.5);
                
                // Update health bar
                battleSvg.select(`[data-ship-id="${target.id}"] .health-fill`)
                    .transition()
                    .duration(200)
                    .attr('width', 20 * (target.health / 100))
                    .attr('fill', target.health > 70 ? '#4CAF50' : target.health > 30 ? '#FFC107' : '#F44336');
                
                if (target.health <= 0 && !target.sunk) {
                    sinkShip(target);
                }
            }
        }
        
        function createCannonEffect(attacker, target) {
            const attackerPixel = map.getPixelFromCoordinate(ol.proj.fromLonLat(attacker.coords));
            const targetPixel = map.getPixelFromCoordinate(ol.proj.fromLonLat(target.coords));
            
            if (!attackerPixel || !targetPixel) return;
            
            const effectGroup = battleSvg.append('g').attr('class', 'cannon-fire');
            
            // Muzzle flash
            effectGroup.append('circle')
                .attr('cx', attackerPixel[0])
                .attr('cy', attackerPixel[1])
                .attr('r', 3)
                .attr('class', 'muzzle-flash')
                .transition()
                .duration(150)
                .attr('r', 12)
                .style('opacity', 0)
                .remove();
            
            // Cannonball
            effectGroup.append('circle')
                .attr('cx', attackerPixel[0])
                .attr('cy', attackerPixel[1])
                .attr('r', 2)
                .attr('class', 'cannonball')
                .transition()
                .duration(400)
                .attr('cx', targetPixel[0] + (Math.random() - 0.5) * 30)
                .attr('cy', targetPixel[1] + (Math.random() - 0.5) * 30)
                .remove();
            
            // Smoke
            effectGroup.append('ellipse')
                .attr('cx', attackerPixel[0])
                .attr('cy', attackerPixel[1])
                .attr('rx', 0)
                .attr('ry', 0)
                .attr('class', 'smoke')
                .transition()
                .duration(1500)
                .attr('rx', 15)
                .attr('ry', 10)
                .style('opacity', 0)
                .remove();
        }
        
        function sinkShip(ship) {
            ship.sunk = true;
            casualties++;
            
            if (soundEnabled) playExplosionSound();
            
            const shipPixel = map.getPixelFromCoordinate(ol.proj.fromLonLat(ship.coords));
            if (!shipPixel) return;
            
            // Explosion effect
            const explosion = battleSvg.append('g').attr('class', 'explosion');
            
            explosion.append('circle')
                .attr('cx', shipPixel[0])
                .attr('cy', shipPixel[1])
                .attr('r', 0)
                .attr('fill', '#FF4500')
                .transition()
                .duration(800)
                .attr('r', 30)
                .style('opacity', 0)
                .remove();
            
            // Debris
            for (let i = 0; i < 6; i++) {
                explosion.append('rect')
                    .attr('x', shipPixel[0])
                    .attr('y', shipPixel[1])
                    .attr('width', 2)
                    .attr('height', 6)
                    .attr('fill', '#8B4513')
                    .transition()
                    .duration(1500)
                    .attr('x', shipPixel[0] + (Math.random() - 0.5) * 60)
                    .attr('y', shipPixel[1] + Math.random() * 40)
                    .style('opacity', 0)
                    .remove();
            }
            
            // Sink ship animation
            battleSvg.select(`[data-ship-id="${ship.id}"]`)
                .transition()
                .duration(2000)
                .style('opacity', 0.3)
                .attr('transform', d => `translate(${d.screenX}, ${d.screenY + 20}) scale(0.8) rotate(${d.angle + 30})`);
            
            if (ship.name === "San Ildefonso") {
                updateBattleStatus("San Ildefonso has been sunk! ⚓");
            }
        }
        
        function updateBattleStatus(customMessage) {
            if (customMessage) {
                document.getElementById('battle-status').textContent = customMessage;
                return;
            }
            
            const minutes = Math.floor(battleTime / 60000);
            const hours = 6 + Math.floor(minutes / 60);
            const displayMinutes = minutes % 60;
            
            document.getElementById('time').textContent = 
                `Time: ${hours.toString().padStart(2, '0')}:${displayMinutes.toString().padStart(2, '0')} ${hours >= 12 ? 'PM' : 'AM'}`;
            document.getElementById('casualties').textContent = `Ships lost: ${casualties}`;
            
            // Update San Ildefonso status
            const sanIldefonso = ships.find(s => s.name === "San Ildefonso");
            if (sanIldefonso && !sanIldefonso.sunk) {
                let status = `San Ildefonso: ${Math.round(sanIldefonso.health)}% hull integrity`;
                if (sanIldefonso.inCombat) {
                    status += " - ENGAGING ENEMY! 🔥";
                }
                if (sanIldefonso.health < 30) {
                    status += " - CRITICAL DAMAGE! ⚠️";
                }
                document.getElementById('san-ildefonso-status').innerHTML = `<strong>${status}</strong>`;
            }
        }
        
        function checkBattleEnd() {
            const totalShips = ships.length;
            const sunkShips = ships.filter(s => s.sunk).length;
            
            if (sunkShips > totalShips * 0.4 || battleTime > 1800000) { // 30 minutes
                battleStarted = false;
                
                const britishLosses = ships.filter(s => s.fleet === 'british' && s.sunk).length;
                const allyLosses = ships.filter(s => (s.fleet === 'spanish' || s.fleet === 'french') && s.sunk).length;
                
                if (allyLosses > britishLosses) {
                    updateBattleStatus("Battle concluded - British victory! Nelson's tactics triumph.");
                } else {
                    updateBattleStatus("Battle concluded - Tactical stalemate achieved.");
                }
            }
        }
        
        // Initialize when page loads
        detectMobile();
        
        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>